<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación de Flujo de Energía Dinámico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        #animation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        #main-container {
            position: relative;
            z-index: 10;
        }

        .module-button {
            transition: box-shadow 300ms ease-in-out;
        }

        .module-container.is-active>.module-button,
        .child-node.is-active {
            box-shadow: 0 0 15px 4px rgba(255, 255, 255, 0.1);
        }

        .expandable-container {
            transition: all 300ms ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .expandable-container.is-expanded {
            max-height: 500px;
            opacity: 1;
            pointer-events: auto;
        }

        .child-nodes-container.is-expanded {
            margin-top: 0.75rem;
        }

        .child-actions.is-expanded {
            margin-top: 0.5rem;
            padding-left: 1.5rem;
        }
    </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="controls" class="absolute top-4 left-4 z-20">
        <label for="year-selector" class="text-sm text-gray-400 mr-2">Año:</label>
        <select id="year-selector"
            class="bg-gray-800 border border-gray-700 rounded-md text-white px-2 py-1 focus:outline-none focus:ring-2 focus:ring-orange-500">
            <!-- Options will be generated by JS -->
        </select>
    </div>

    <div id="main-container" class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-3">

        <!-- Production Module -->
        <div id="production-container" class="module-container relative is-active">
            <button data-value="0"
                class="module-button flex items-center w-full bg-gray-800 border border-gray-700 rounded-full shadow-lg hover:shadow-orange-500/30 focus:outline-none">
                <span
                    class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-orange-600 rounded-full pointer-events-none">
                    <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </span>
                <div class="px-3 text-left pointer-events-none">
                    <div class="text-gray-300 font-semibold text-sm">Producción</div>
                    <div id="production-total" class="text-orange-400 font-bold text-xs">0.00 PJ</div>
                </div>
                <span id="production-expander"
                    class="plus-button flex-shrink-0 flex items-center justify-center w-9 h-9 border-l border-gray-700 text-gray-500 hover:text-white transition-colors">
                    <svg class="h-4 w-4 expand-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </span>
            </button>
            <div id="production-child-nodes"
                class="expandable-container child-nodes-container flex flex-col items-center gap-2 pl-4">
                <!-- Production children generated by JS -->
            </div>
        </div>

        <div class="hidden md:block w-16 h-1 bg-gray-700/50 rounded-full"></div>

        <!-- Placeholder Destination Module -->
        <div id="transform-container" class="module-container relative">
            <button
                class="module-button flex items-center w-full bg-gray-800 border border-gray-700 rounded-full shadow-lg hover:shadow-purple-500/30 focus:outline-none">
                <span
                    class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-purple-600 rounded-full pointer-events-none">
                    <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456z" />
                    </svg>
                </span>
                <span class="px-3 text-gray-300 font-semibold text-sm pointer-events-none">Transformaciones</span>
            </button>
        </div>

    </div>

    <canvas id="animation-canvas"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.getElementById('main-container');
            const canvas = document.getElementById('animation-canvas');
            const ctx = canvas.getContext('2d');
            const yearSelector = document.getElementById('year-selector');

            let particles = [];
            let activeNodeId = 'production-container';
            let focusedChildId = null;
            let isProductionExpanded = false;
            let isGlobalFlowActive = true;
            let currentYear = '2024';

            const masterEnergetics = {
                'Carbón mineral': { id: 'carbon-mineral', color: '107, 114, 128' },
                'Petróleo crudo': { id: 'petroleo-crudo', color: '239, 68, 68' },
                'Condensados': { id: 'condensados', color: '217, 119, 6' },
                'Gas natural': { id: 'gas-natural', color: '59, 130, 246' },
                'Energía Nuclear': { id: 'energia-nuclear', color: '217, 70, 239' },
                'Energia Hidraúlica': { id: 'energia-hidraulica', color: '34, 211, 238' },
                'Geoenergía': { id: 'geoenergia', color: '124, 58, 237' },
                'Energía solar': { id: 'energia-solar', color: '252, 211, 77' },
                'Energía eólica': { id: 'energia-eolica', color: '219, 234, 254' },
                'Bagazo de caña': { id: 'bagazo-cana', color: '202, 138, 4' },
                'Leña': { id: 'lena', color: '22, 163, 74' },
                'Biogás': { id: 'biogas', color: '134, 239, 172' },
            };

            const productionRawData = [{ "Nodo Hijo": "Carbón mineral", "2010": 367.32, "2011": 479.23, "2012": 342.24, "2013": 331.69, "2014": 332.99, "2015": 394.09, "2016": 320.69, "2017": 333.49, "2018": 279.58, "2019": 230.46, "2020": 180.31, "2021": 137.56, "2022": 137.59, "2023": 14.98, "2024": 14.99 }, { "Nodo Hijo": "Petróleo crudo", "2010": 5756.5, "2011": 5702, "2012": 5691.5, "2013": 5633.87, "2014": 5425.45, "2015": 5063.58, "2016": 4796.64, "2017": 4341.84, "2018": 4042.73, "2019": 3750.1, "2020": 3714.81, "2021": 3718.61, "2022": 3624.34, "2023": 3692.47, "2024": 3469.98 }, { "Nodo Hijo": "Condensados", "2010": 92.51, "2011": 100.38, "2012": 87.69, "2013": 134.11, "2014": 106.31, "2015": 98.83, "2016": 88.31, "2017": 67.28, "2018": 48.2, "2019": 58.84, "2020": 132.16, "2021": 260.7, "2022": 499.44, "2023": 639.75, "2024": 604.45 }, { "Nodo Hijo": "Gas natural", "2010": 2803.41, "2011": 2633.32, "2012": 2549.66, "2013": 2543.95, "2014": 2608.48, "2015": 2556.21, "2016": 2285.85, "2017": 2006.99, "2018": 1925.04, "2019": 1946.41, "2020": 1932.03, "2021": 1892.98, "2022": 1918.97, "2023": 1994.81, "2024": 1831.44 }, { "Nodo Hijo": "Energía Nuclear", "2010": 63.94, "2011": 106.39, "2012": 91.32, "2013": 122.6, "2014": 112.6, "2015": 130.41, "2016": 109.95, "2017": 113.22, "2018": 141.65, "2019": 116.48, "2020": 117.46, "2021": 124.99, "2022": 114.17, "2023": 130.34, "2024": 129.51 }, { "Nodo Hijo": "Energia Hidraúlica", "2010": 140.65, "2011": 136.79, "2012": 119.38, "2013": 104.97, "2014": 143.24, "2015": 113.84, "2016": 113.38, "2017": 115.13, "2018": 117.2, "2019": 85.77, "2020": 97.45, "2021": 126.12, "2022": 129.23, "2023": 74.93, "2024": 86.52 }, { "Nodo Hijo": "Geoenergía", "2010": 28.76, "2011": 27.42, "2012": 24.56, "2013": 25.49, "2014": 25.33, "2015": 26.53, "2016": 25.74, "2017": 23.73, "2018": 21.16, "2019": 20.94, "2020": 19.12, "2021": 17.6, "2022": 18.46, "2023": 17.29, "2024": 14.78 }, { "Nodo Hijo": "Energía solar", "2010": 14.71, "2011": 17.15, "2012": 18.75, "2013": 19.68, "2014": 22.88, "2015": 25.2, "2016": 27.71, "2017": 31.02, "2018": 39.94, "2019": 64.52, "2020": 83.88, "2021": 99.39, "2022": 98.86, "2023": 108.61, "2024": 114.36 }, { "Nodo Hijo": "Energía eólica", "2010": 4.72, "2011": 6.09, "2012": 13.42, "2013": 15.43, "2014": 23.69, "2015": 32.23, "2016": 38.42, "2017": 38.01, "2018": 45.23, "2019": 60.82, "2020": 71.67, "2021": 76.65, "2022": 73.91, "2023": 75.29, "2024": 72.66 }, { "Nodo Hijo": "Bagazo de caña", "2010": 99.08, "2011": 99.17, "2012": 101.76, "2013": 140.35, "2014": 111.27, "2015": 107, "2016": 107.9, "2017": 107.39, "2018": 107.15, "2019": 113.25, "2020": 99.66, "2021": 103.95, "2022": 111.59, "2023": 97.38, "2024": 95.77 }, { "Nodo Hijo": "Leña", "2010": 138.37, "2011": 137.7, "2012": 137.02, "2013": 136.36, "2014": 135.69, "2015": 135.01, "2016": 134.34, "2017": 133.67, "2018": 133, "2019": 132.32, "2020": 131.65, "2021": 131.1, "2022": 130.54, "2023": 129.98, "2024": 129.42 }, { "Nodo Hijo": "Biogás", "2010": 1.3, "2011": 1.47, "2012": 1.82, "2013": 1.97, "2014": 1.94, "2015": 1.87, "2016": 1.91, "2017": 2.52, "2018": 2.84, "2019": 2.8, "2020": 2.53, "2021": 2.71, "2022": 2.89, "2023": 3.07, "2024": 3.25 }];

            const MAX_VALUE = 6000; // Approx max value for scaling

            function populateYearSelector() {
                for (let year = 2024; year >= 2010; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelector.appendChild(option);
                }
            }

            function updateNodesForYear(year) {
                const container = document.getElementById('production-child-nodes');
                container.innerHTML = '';
                let totalProduction = 0;

                productionRawData.forEach(item => {
                    const value = item[year] || 0;
                    if (value > 0) {
                        totalProduction += value;
                        const energeticInfo = masterEnergetics[item['Nodo Hijo']] || { id: 'unknown', color: '255,255,255' };
                        const nodeId = 'prod-' + energeticInfo.id;
                        const nodeHtml = `
                            <div class="w-full relative">
                                <button id="${nodeId}" data-value="${value}" data-color="${energeticInfo.color}" class="child-node module-button flex items-center w-full bg-gray-800 border border-gray-700 rounded-full shadow-md">
                                    <span class="flex-shrink-0 w-7 h-7 rounded-full pointer-events-none" style="background-color: rgb(${energeticInfo.color})"></span>
                                    <div class="px-2 text-xs flex-1 text-left pointer-events-none">
                                        <div>${item['Nodo Hijo']}</div>
                                        <div class="font-bold" style="color: rgb(${energeticInfo.color})">${value.toLocaleString()} PJ</div>
                                    </div>
                                    <span class="plus-button flex-shrink-0 flex items-center justify-center w-7 h-7 border-l border-gray-700 text-gray-500 hover:text-white"><svg class="h-3 w-3 expand-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg></span>
                                </button>
                                <div class="child-actions expandable-container">
                                     <a href="#" class="block py-1 text-xs text-gray-400 hover:text-white">Acción de ${item['Nodo Hijo']}</a>
                                </div>
                            </div>`;
                        container.innerHTML += nodeHtml;
                    }
                });

                const productionTotalEl = document.getElementById('production-total');
                productionTotalEl.textContent = `${totalProduction.toLocaleString(undefined, { maximumFractionDigits: 2 })} PJ`;
                productionTotalEl.closest('.module-button').dataset.value = totalProduction;
            }

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            class Particle {
                constructor(startX, startY, endX, endY, color) {
                    this.x = startX; this.y = startY; this.color = color;
                    this.size = Math.random() * 2.5 + 1.5;
                    this.speed = Math.random() * 0.5 + 0.5;
                    const angle = Math.atan2(endY - startY, endX - startX);
                    this.vx = Math.cos(angle) * this.speed;
                    this.vy = Math.sin(angle) * this.speed;
                    this.life = 200;
                    this.opacity = 0;
                    this.maxOpacity = Math.random() * 0.5 + 0.2;
                }
                update() {
                    this.x += this.vx; this.y += this.vy; this.life--;
                    if (this.life > 170) this.opacity = Math.min(this.maxOpacity, this.opacity + 0.05);
                    else if (this.life < 30) this.opacity = Math.max(0, this.opacity - 0.05);
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${this.color}, ${this.opacity})`;
                    ctx.fill();
                }
            }

            function createFlowingParticles(sourceElement, targetElement, overrideColor = null) {
                if (!sourceElement || !targetElement) return;
                const value = parseFloat(sourceElement.dataset.value) || 0;
                const baseRate = 1;
                const maxAdditionalRate = 4;
                const particlesToCreate = baseRate + (Math.abs(value) / MAX_VALUE) * maxAdditionalRate;

                for (let i = 0; i < particlesToCreate; i++) {
                    const startRect = sourceElement.getBoundingClientRect();
                    const endRect = targetElement.getBoundingClientRect();
                    const color = overrideColor || sourceElement.dataset.color || '255,255,255';
                    let startX, startY, endX, endY;
                    if (window.innerWidth < 768) {
                        startX = startRect.left + startRect.width / 2;
                        startY = startRect.bottom;
                        endX = endRect.left + endRect.width / 2;
                        endY = endRect.top;
                    } else {
                        startX = startRect.right;
                        startY = startRect.top + startRect.height / 2;
                        endX = endRect.left;
                        endY = endRect.top + endRect.height / 2;
                    }
                    particles.push(new Particle(startX, startY, endX, endY, color));
                }
            }

            function manageParticleCreation() {
                const sourceContainer = document.getElementById('production-container');
                const targetContainer = document.getElementById('transform-container');

                if (isProductionExpanded) {
                    document.getElementById('production-child-nodes').querySelectorAll('.child-node').forEach(child => {
                        createFlowingParticles(child, targetContainer.querySelector('.module-button'), child.dataset.color);
                    });
                } else {
                    createFlowingParticles(sourceContainer.querySelector('.module-button'), targetContainer.querySelector('.module-button'));
                }
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (isGlobalFlowActive) {
                    manageParticleCreation();
                }
                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.update();
                    p.draw();
                    if (p.life <= 0) particles.splice(i, 1);
                }
                requestAnimationFrame(animate);
            }

            function toggleExpandable(plusButton) {
                const icon = plusButton.querySelector('.expand-icon');
                let container;
                if (plusButton.id === 'production-expander') {
                    container = document.getElementById('production-child-nodes');
                } else {
                    const parentButton = plusButton.closest('button.child-node');
                    container = parentButton ? parentButton.nextElementSibling : null;
                }

                if (container && container.classList.contains('expandable-container')) {
                    const isExpanded = container.classList.toggle('is-expanded');
                    if (icon) {
                        icon.innerHTML = isExpanded ? `<path d="M18 12H6"/>` : `<path d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>`;
                    }
                    if (container.id === 'production-child-nodes') isProductionExpanded = isExpanded;
                    particles = [];
                }
            }

            mainContainer.addEventListener('click', (e) => {
                const plusButton = e.target.closest('.plus-button');
                if (plusButton) {
                    e.stopPropagation();
                    toggleExpandable(plusButton);
                }
            });

            yearSelector.addEventListener('change', (e) => {
                currentYear = e.target.value;
                updateNodesForYear(currentYear);
                particles = [];
            });

            // Initial Setup
            populateYearSelector();
            updateNodesForYear(currentYear);
            resizeCanvas();
            animate();
        });
    </script>
</body>

</html>