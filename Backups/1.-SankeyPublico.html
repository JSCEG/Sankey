<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankey Avanzado con Nodos Contraíbles</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7fa;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            color: #2c3e50;
        }

        #sankey-canvas {
            position: relative;
            width: 100%;
            height: 80vh;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            box-sizing: border-box;
            cursor: default;
        }

        /* --- ESTILOS PARA NODOS Y GRUPOS --- */
        .sankey-node, .sankey-group-node {
            position: absolute;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            transition: all 0.4s ease;
        }

        /* New style for grandparent nodes */
        .sankey-grandparent-node {
            position: absolute;
            border-radius: 12px; /* Slightly larger border-radius */
            cursor: move;
            user-select: none;
            transition: all 0.4s ease;
            padding: 25px; /* More padding */
            padding-top: 60px; /* More space for title */
            background-color: #ecf0f1; /* Light grey background */
            border: 3px solid #3498db; /* Distinct border color */
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            z-index: 5; /* Below parents, above links */
        }

        .grandparent-title {
            position: absolute;
            top: 20px;
            left: 25px;
            font-size: 1.5em; /* Larger title */
            font-weight: 700;
            color: #2c3e50;
        }

        .grandparent-total-value {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 1.5em;
            font-weight: 700;
            color: #2980b9;
        }

        /* Adjustments for existing parent (group) nodes */
        .sankey-group-node { /* This will now be for 'parent' nodes */
            padding: 15px; /* Slightly less padding than grandparent */
            padding-top: 45px;
            background-color: #ffffff; /* White background */
            border: 2px dashed #adb5bd;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            z-index: 1; /* Keep it low */
        }

        /* New style for collapsed group nodes (rectangulito) */
        .sankey-group-node.collapsed-group {
            width: 150px; /* Fixed width for collapsed rectangle */
            height: 40px; /* Fixed height for collapsed rectangle */
            padding: 5px 10px; /* Padding for content */
            border-radius: 8px; /* Slightly rounded corners */
            background-color: #ffffff; /* White background */
            border: 2px solid #adb5bd; /* Solid border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 10;
            cursor: move;
            user-select: none;
            transition: all 0.4s ease;
        }

        .sankey-group-node.collapsed-group .node-icon { font-size: 20px; }
        .sankey-group-node.collapsed-group .node-info { flex-grow: 1; display: block; }
        .sankey-group-node.collapsed-group .node-label { font-weight: 600; font-size: 12px; color: #34495e; }
        .sankey-group-node.collapsed-group .node-value { font-size: 10px; color: #555; }

        /* Adjustments for child (energetic) nodes */
        .sankey-node {
            width: 40px; /* Larger size for circle */
            height: 40px; /* Larger size for circle */
            padding: 0; /* No padding for circular nodes */
            border-radius: 50%; /* Make them circular */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0; /* No gap for circular nodes */
            font-size: 12px; /* Slightly larger font for value */
            text-align: center;
            flex-direction: column; /* Stack icon and value */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            background-color: #fdfdfd;
            border: 1px solid #ccc;
        }

        .sankey-grandparent-node:hover, .sankey-group-node:hover, .sankey-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .sankey-grandparent-node:hover, .sankey-group-node:hover {
             box-shadow: none; /* Grandparent and parent hover should not have box-shadow */
        }

        .sankey-node.dragging, .sankey-group-node.dragging, .sankey-grandparent-node.dragging {
            z-index: 1000;
            cursor: grabbing;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        
        .group-title {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 1.2em;
            font-weight: 600;
            color: #34495e;
        }
        .group-total-value {
             position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.2em;
            font-weight: 600;
            color: #3498db;
        }

        .node-icon {
            font-size: 16px; /* Adjust icon size for circle */
            line-height: 1;
        }
        .node-info {
            display: none; /* Hide label and value by default for circular nodes */
        }

        /* When hovered, show more info for child nodes */
        .sankey-node:hover .node-info {
            display: block;
            position: absolute;
            background-color: rgba(255,255,255,0.95);
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
            white-space: nowrap;
            top: -40px; /* Position above the circle */
            left: 50%;
            transform: translateX(-50%);
        }

        .sankey-node:hover .node-label {
            font-weight: 600;
            font-size: 12px;
            color: #34495e;
        }

        .sankey-node:hover .node-value {
            font-size: 10px;
            color: #555;
        }

        #sankey-svg-links {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .sankey-link, .particle {
            transition: opacity 0.4s ease;
        }

        .sankey-link { fill: none; stroke: #e0e0e0; stroke-opacity: 0.7; }
        .particle { fill-opacity: 0.9; stroke: white; stroke-width: 0.5px; }

        /* --- LÓGICA DE ENFOQUE --- */
        .faded {
            opacity: 0.1 !important;
        }
        .focused {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.25);
        }

        .sankey-grandparent-node.focused {
            transform: scale(1.02); /* Less aggressive scale for grandparents */
            box-shadow: 0 8px 25px rgba(44, 62, 80, 0.3);
        }

        .sankey-grandparent-node.faded {
            opacity: 0.1 !important;
        }

        /* --- BOTÓN Y MENÚ --- */
        .node-add-button {
            position: absolute;
            bottom: -10px; /* Adjust position */
            left: 50%;
            transform: translateX(-50%);
            width: 24px; /* Smaller button */
            height: 24px;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px; /* Smaller font */
            line-height: 20px;
            font-weight: 300;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            text-shadow: 0 0 3px rgba(0,0,0,0.4);
            z-index: 20;
        }

        .sankey-node:hover .node-add-button, .sankey-group-node:hover .node-add-button, .sankey-grandparent-node:hover .node-add-button {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) scale(1.1);
        }

        .node-popup-menu {
            position: absolute;
            bottom: -50px; /* Adjust position */
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 5px;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .node-popup-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(10px);
        }

        .popup-item { padding: 8px 15px; cursor: pointer; font-size: 14px; color: #333; border-radius: 4px; white-space: nowrap; }
        .popup-item:hover { background-color: #f5f5f5; }

    </style>
</head>
<body>

    <header>
        <h1>Sankey Avanzado con Jerarquía de Nodos y Foco de Flujo</h1>
        <p>Haz clic en un nodo para enfocar su flujo. Usa el botón '+' en los nodos Abuelo y Padre para expandir o contraer.</p>
    </header>

    <div id="sankey-canvas">
        <svg id="sankey-svg-links"></svg>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('sankey-canvas');
            const svgLinks = document.getElementById('sankey-svg-links');
            const SVG_NS = "http://www.w3.org/2000/svg";
            let focusedNodeId = null;

            const nodesData = [
                // Grandparent nodes
                { id: 'oferta-grandparent', type: 'grandparent', label: 'Oferta', color: '#1abc9c', x: 30, y: 30, isCollapsed: false },
                { id: 'transformacion-grandparent', type: 'grandparent', label: 'Transformación', color: '#f39c12', x: 550, y: 30, isCollapsed: false },
                { id: 'consumo-grandparent', type: 'grandparent', label: 'Consumo', color: '#e74c3c', x: 950, y: 30, isCollapsed: false },

                // Parent nodes (groups)
                { id: 'prod-group', type: 'group', grandparent: 'oferta-grandparent', label: 'Producción', color: '#2c3e50', x: 50, y: 50, isCollapsed: false },
                { id: 'imp-group', type: 'group', grandparent: 'oferta-grandparent', label: 'Importación', color: '#3498db', x: 50, y: 300, isCollapsed: false },
                { id: 'varinv-group', type: 'group', grandparent: 'oferta-grandparent', label: 'Variación Inventarios', color: '#9b59b6', x: 50, y: 550, isCollapsed: false },
                
                { id: 'refdes-group', type: 'group', grandparent: 'transformacion-grandparent', label: 'Refinerías y Despuntadoras', color: '#d35400', x: 570, y: 50, isCollapsed: false },
                { id: 'pgfra-group', type: 'group', grandparent: 'transformacion-grandparent', label: 'Plantas de Gas y Fraccionadoras', color: '#e67e22', x: 570, y: 300, isCollapsed: false },
                { id: 'ce-group', type: 'group', grandparent: 'transformacion-grandparent', label: 'Centrales Eléctricas', color: '#27ae60', x: 570, y: 550, isCollapsed: false },

                { id: 'confin-group', type: 'group', grandparent: 'consumo-grandparent', label: 'Consumo Final', color: '#c0392b', x: 970, y: 50, isCollapsed: false },
                { id: 'exp-group', type: 'group', grandparent: 'consumo-grandparent', label: 'Exportación', color: '#8e44ad', x: 970, y: 300, isCollapsed: false },
                { id: 'ena-group', type: 'group', grandparent: 'consumo-grandparent', label: 'Energía No Aprovechada', color: '#7f8c8d', x: 970, y: 550, isCollapsed: false },


                // Child nodes (energetics) - Production
                { id: 'carbon', type: 'node', parent: 'prod-group', label: 'Carbón mineral', value: 367.32, icon: '⚫', color: '#795548' },
                { id: 'petroleo', type: 'node', parent: 'prod-group', label: 'Petróleo crudo', value: 5756.50, icon: '🛢️', color: '#212121' },
                { id: 'condensados', type: 'node', parent: 'prod-group', label: 'Condensados', value: 92.51, icon: '💧', color: '#BDBDBD' },
                { id: 'gas', type: 'node', parent: 'prod-group', label: 'Gas natural', value: 2803.41, icon: '💨', color: '#03A9F4' },
                { id: 'nuclear', type: 'node', parent: 'prod-group', label: 'Energía Nuclear', value: 63.94, icon: '⚛️', color: '#F44336' },
                { id: 'hidro', type: 'node', parent: 'prod-group', label: 'Energía Hidráulica', value: 140.65, icon: '🌊', color: '#00BCD4' },
                { id: 'geo', type: 'node', parent: 'prod-group', label: 'Geoenergía', value: 28.76, icon: '🌋', color: '#FF5722' },
                { id: 'solar', type: 'node', parent: 'prod-group', label: 'Energía solar', value: 14.71, icon: '☀️', color: '#FFC107' },
                { id: 'eolica', type: 'node', parent: 'prod-group', label: 'Energía eólica', value: 4.72, icon: '🌬️', color: '#81D4FA' },
                { id: 'bagazo', type: 'node', parent: 'prod-group', label: 'Bagazo de caña', value: 99.08, icon: '🌿', color: '#8BC34A' },
                { id: 'lena', type: 'node', parent: 'prod-group', label: 'Leña', value: 138.37, icon: '🪵', color: '#A1887F' },
                { id: 'biogas', type: 'node', parent: 'prod-group', label: 'Biogás', value: 1.30, icon: '♻️', color: '#4CAF50' },

                // Child nodes (energetics) - Importation (example, values from CSV will populate this)
                { id: 'imp-carbon', type: 'node', parent: 'imp-group', label: 'Carbón mineral', value: 222.90, icon: '⚫', color: '#795548' },
                { id: 'imp-petroleo', type: 'node', parent: 'imp-group', label: 'Petróleo crudo', value: 0.00, icon: '🛢️', color: '#212121' },
                { id: 'imp-gas', type: 'node', parent: 'imp-group', label: 'Gas natural', value: 0.00, icon: '💨', color: '#03A9F4' },
                { id: 'imp-coque-carbon', type: 'node', parent: 'imp-group', label: 'Coque de carbón', value: 20.80, icon: '⚫', color: '#795548' },
                { id: 'imp-coque-petroleo', type: 'node', parent: 'imp-group', label: 'Coque de petróleo', value: 95.36, icon: '🛢️', color: '#212121' },
                { id: 'imp-glp', type: 'node', parent: 'imp-group', label: 'Gas licuado de petróleo', value: 122.37, icon: '💨', color: '#03A9F4' },
                { id: 'imp-gasolinas', type: 'node', parent: 'imp-group', label: 'Gasolinas y naftas', value: 761.70, icon: '⛽', color: '#FFC107' },
                { id: 'imp-querosenos', type: 'node', parent: 'imp-group', label: 'Querosenos', value: 8.05, icon: '✈️', color: '#9b59b6' },
                { id: 'imp-diesel', type: 'node', parent: 'imp-group', label: 'Diesel', value: 379.26, icon: '🚚', color: '#546E7A' },
                { id: 'imp-combustoleo', type: 'node', parent: 'imp-group', label: 'Combustóleo', value: 25.55, icon: '🔥', color: '#FF5722' },
                { id: 'imp-gas-natural-seco', type: 'node', parent: 'imp-group', label: 'Gas natural seco', value: 877.84, icon: '💨', color: '#03A9F4' },
                { id: 'imp-electricidad', type: 'node', parent: 'imp-group', label: 'Energía eléctrica', value: 1.57, icon: '⚡', color: '#00BCD4' },

                // Child nodes (energetics) - Variación Inventarios (example)
                { id: 'varinv-carbon', type: 'node', parent: 'varinv-group', label: 'Carbón mineral', value: -0.59, icon: '⚫', color: '#795548' },
                { id: 'varinv-petroleo', type: 'node', parent: 'varinv-group', label: 'Petróleo crudo', value: -13.29, icon: '🛢️', color: '#212121' },
                { id: 'varinv-condensados', type: 'node', parent: 'varinv-group', label: 'Condensados', value: 0.37, icon: '💧', color: '#BDBDBD' },
                { id: 'varinv-gas', type: 'node', parent: 'varinv-group', label: 'Gas natural', value: -13.86, icon: '💨', color: '#03A9F4' },
                { id: 'varinv-coque-petroleo', type: 'node', parent: 'varinv-group', label: 'Coque de petróleo', value: -2.58, icon: '🛢️', color: '#212121' },
                { id: 'varinv-glp', type: 'node', parent: 'varinv-group', label: 'Gas licuado de petróleo', value: 0.00, icon: '💨', color: '#03A9F4' },
                { id: 'varinv-gasolinas', type: 'node', parent: 'varinv-group', label: 'Gasolinas y naftas', value: 0.00, icon: '⛽', color: '#FFC107' },
                { id: 'varinv-querosenos', type: 'node', parent: 'varinv-group', label: 'Querosenos', value: 0.00, icon: '✈️', color: '#9b59b6' },
                { id: 'varinv-diesel', type: 'node', parent: 'varinv-group', label: 'Diesel', value: 16.20, icon: '🚚', color: '#546E7A' },
                { id: 'varinv-combustoleo', type: 'node', parent: 'varinv-group', label: 'Combustóleo', value: -3.71, icon: '🔥', color: '#FF5722' },
                { id: 'varinv-otros', type: 'node', parent: 'varinv-group', label: 'Otros energéticos', value: -0.14, icon: '✨', color: '#7f8c8d' },
                { id: 'varinv-gas-natural-seco', type: 'node', parent: 'varinv-group', label: 'Gas natural seco', value: 0.62, icon: '💨', color: '#03A9F4' },

                // Child nodes (energetics) - Refinerías y Despuntadoras (example)
                { id: 'refdes-petroleo', type: 'node', parent: 'refdes-group', label: 'Petróleo crudo', value: -2392.17, icon: '🛢️', color: '#212121' },
                { id: 'refdes-condensados', type: 'node', parent: 'refdes-group', label: 'Condensados', value: 0.00, icon: '💧', color: '#BDBDBD' },
                { id: 'refdes-gas', type: 'node', parent: 'refdes-group', label: 'Gas natural', value: 0.00, icon: '💨', color: '#03A9F4' },
                { id: 'refdes-coque-petroleo', type: 'node', parent: 'refdes-group', label: 'Coque de petróleo', value: 34.07, icon: '🛢️', color: '#212121' },
                { id: 'refdes-glp', type: 'node', parent: 'refdes-group', label: 'Gas licuado de petróleo', value: 34.67, icon: '💨', color: '#03A9F4' },
                { id: 'refdes-gasolinas', type: 'node', parent: 'refdes-group', label: 'Gasolinas y naftas', value: 614.97, icon: '⛽', color: '#FFC107' },
                { id: 'refdes-querosenos', type: 'node', parent: 'refdes-group', label: 'Querosenos', value: 85.09, icon: '✈️', color: '#9b59b6' },
                { id: 'refdes-diesel', type: 'node', parent: 'refdes-group', label: 'Diesel', value: 461.71, icon: '🚚', color: '#546E7A' },
                { id: 'refdes-combustoleo', type: 'node', parent: 'refdes-group', label: 'Combustóleo', value: 583.41, icon: '🔥', color: '#FF5722' },
                { id: 'refdes-otros', type: 'node', parent: 'refdes-group', label: 'Otros energéticos', value: 69.70, icon: '✨', color: '#7f8c8d' },
                { id: 'refdes-gas-natural-seco', type: 'node', parent: 'refdes-group', label: 'Gas natural seco', value: 451.22, icon: '💨', color: '#03A9F4' },

                // Child nodes (energetics) - Plantas de Gas y Fraccionadoras (example)
                { id: 'pgfra-condensados', type: 'node', parent: 'pgfra-group', label: 'Condensados', value: -92.87, icon: '💧', color: '#BDBDBD' },
                { id: 'pgfra-gas', type: 'node', parent: 'pgfra-group', label: 'Gas natural', value: -1801.24, icon: '💨', color: '#03A9F4' },
                { id: 'pgfra-glp', type: 'node', parent: 'pgfra-group', label: 'Gas licuado de petróleo', value: 286.13, icon: '💨', color: '#03A9F4' },
                { id: 'pgfra-gasolinas', type: 'node', parent: 'pgfra-group', label: 'Gasolinas y naftas', value: 146.36, icon: '⛽', color: '#FFC107' },
                { id: 'pgfra-otros', type: 'node', parent: 'pgfra-group', label: 'Otros energéticos', value: 86.50, icon: '✨', color: '#7f8c8d' },
                { id: 'pgfra-gas-natural-seco', type: 'node', parent: 'pgfra-group', label: 'Gas natural seco', value: 1359.65, icon: '💨', color: '#03A9F4' },

                // Child nodes (energetics) - Centrales Eléctricas (example)
                { id: 'ce-carbon', type: 'node', parent: 'ce-group', label: 'Carbón mineral', value: -345.76, icon: '⚫', color: '#795548' },
                { id: 'ce-nuclear', type: 'node', parent: 'ce-group', label: 'Energía Nuclear', value: -63.94, icon: '⚛️', color: '#F44336' },
                { id: 'ce-hidro', type: 'node', parent: 'ce-group', label: 'Energía Hidráulica', value: -140.65, icon: '🌊', color: '#00BCD4' },
                { id: 'ce-geo', type: 'node', parent: 'ce-group', label: 'Geoenergía', value: -28.76, icon: '🌋', color: '#FF5722' },
                { id: 'ce-solar', type: 'node', parent: 'ce-group', label: 'Energía solar', value: 0.00, icon: '☀️', color: '#FFC107' },
                { id: 'ce-eolica', type: 'node', parent: 'ce-group', label: 'Energía eólica', value: -4.72, icon: '🌬️', color: '#81D4FA' },
                { id: 'ce-bagazo', type: 'node', parent: 'ce-group', label: 'Bagazo de caña', value: -46.25, icon: '🌿', color: '#8BC34A' },
                { id: 'ce-biogas', type: 'node', parent: 'ce-group', label: 'Biogás', value: -1.30, icon: '♻️', color: '#4CAF50' },
                { id: 'ce-coque-petroleo', type: 'node', parent: 'ce-group', label: 'Coque de petróleo', value: -38.29, icon: '🛢️', color: '#212121' },
                { id: 'ce-diesel', type: 'node', parent: 'ce-group', label: 'Diesel', value: -18.81, icon: '🚚', color: '#546E7A' },
                { id: 'ce-combustoleo', type: 'node', parent: 'ce-group', label: 'Combustóleo', value: -203.56, icon: '🔥', color: '#FF5722' },
                { id: 'ce-gas-natural-seco', type: 'node', parent: 'ce-group', label: 'Gas natural seco', value: -1429.93, icon: '💨', color: '#03A9F4' },
                { id: 'ce-electricidad', type: 'node', parent: 'ce-group', label: 'Energía eléctrica', value: 1051.66, icon: '⚡', color: '#00BCD4' },

                // Child nodes (energetics) - Consumo Final (example)
                { id: 'confin-carbon', type: 'node', parent: 'confin-group', label: 'Carbón mineral', value: 160.29, icon: '⚫', color: '#795548' },
                { id: 'confin-solar', type: 'node', parent: 'confin-group', label: 'Energía solar', value: 14.71, icon: '☀️', color: '#FFC107' },
                { id: 'confin-bagazo', type: 'node', parent: 'confin-group', label: 'Bagazo de caña', value: 51.85, icon: '🌿', color: '#8BC34A' },
                { id: 'confin-lena', type: 'node', parent: 'confin-group', label: 'Leña', value: 138.37, icon: '🪵', color: '#A1887F' },
                { id: 'confin-coque-carbon', type: 'node', parent: 'confin-group', label: 'Coque de carbón', value: 73.13, icon: '⚫', color: '#795548' },
                { id: 'confin-coque-petroleo', type: 'node', parent: 'confin-group', label: 'Coque de petróleo', value: 80.31, icon: '🛢️', color: '#212121' },
                { id: 'confin-glp', type: 'node', parent: 'confin-group', label: 'Gas licuado de petróleo', value: 444.93, icon: '💨', color: '#03A9F4' },
                { id: 'confin-gasolinas', type: 'node', parent: 'confin-group', label: 'Gasolinas y naftas', value: 1399.09, icon: '⛽', color: '#FFC107' },
                { id: 'confin-querosenos', type: 'node', parent: 'confin-group', label: 'Querosenos', value: 90.12, icon: '✈️', color: '#9b59b6' },
                { id: 'confin-diesel', type: 'node', parent: 'confin-group', label: 'Diesel', value: 765.98, icon: '🚚', color: '#546E7A' },
                { id: 'confin-combustoleo', type: 'node', parent: 'confin-group', label: 'Combustóleo', value: 52.76, icon: '🔥', color: '#FF5722' },
                { id: 'confin-otros', type: 'node', parent: 'confin-group', label: 'Otros energéticos', value: 149.72, icon: '✨', color: '#7f8c8d' },
                { id: 'confin-gas-natural-seco', type: 'node', parent: 'confin-group', label: 'Gas natural seco', value: 501.39, icon: '💨', color: '#03A9F4' },
                { id: 'confin-electricidad', type: 'node', parent: 'confin-group', label: 'Energía eléctrica', value: 826.18, icon: '⚡', color: '#00BCD4' },

                // Child nodes (energetics) - Exportación (example)
                { id: 'exp-carbon', type: 'node', parent: 'exp-group', label: 'Carbón mineral', value: -3.22, icon: '⚫', color: '#795548' },
                { id: 'exp-petroleo', type: 'node', parent: 'exp-group', label: 'Petróleo crudo', value: -3301.00, icon: '🛢️', color: '#212121' },
                { id: 'exp-condensados', type: 'node', parent: 'exp-group', label: 'Condensados', value: 0.00, icon: '💧', color: '#BDBDBD' },
                { id: 'exp-gas', type: 'node', parent: 'exp-group', label: 'Gas natural', value: 0.00, icon: '💨', color: '#03A9F4' },
                { id: 'exp-coque-carbon', type: 'node', parent: 'exp-group', label: 'Coque de carbón', value: -0.14, icon: '⚫', color: '#795548' },
                { id: 'exp-coque-petroleo', type: 'node', parent: 'exp-group', label: 'Coque de petróleo', value: -0.06, icon: '🛢️', color: '#212121' },
                { id: 'exp-glp', type: 'node', parent: 'exp-group', label: 'Gas licuado de petróleo', value: -0.14, icon: '💨', color: '#03A9F4' },
                { id: 'exp-gasolinas', type: 'node', parent: 'exp-group', label: 'Gasolinas y naftas', value: -125.95, icon: '⛽', color: '#FFC107' },
                { id: 'exp-querosenos', type: 'node', parent: 'exp-group', label: 'Querosenos', value: -2.66, icon: '✈️', color: '#9b59b6' },
                { id: 'exp-diesel', type: 'node', parent: 'exp-group', label: 'Diesel', value: -2.87, icon: '🚚', color: '#546E7A' },
                { id: 'exp-combustoleo', type: 'node', parent: 'exp-group', label: 'Combustóleo', value: -284.04, icon: '🔥', color: '#FF5722' },
                { id: 'exp-otros', type: 'node', parent: 'exp-group', label: 'Otros energéticos', value: -3.82, icon: '✨', color: '#7f8c8d' },
                { id: 'exp-gas-natural-seco', type: 'node', parent: 'exp-group', label: 'Gas natural seco', value: -30.68, icon: '💨', color: '#03A9F4' },
                { id: 'exp-electricidad', type: 'node', parent: 'exp-group', label: 'Energía eléctrica', value: -21.82, icon: '⚡', color: '#00BCD4' },

                // Child nodes (energetics) - Energía No Aprovechada (example)
                { id: 'ena-petroleo', type: 'node', parent: 'ena-group', label: 'Petróleo crudo', value: 0.00, icon: '🛢️', color: '#212121' },
                { id: 'ena-condensados', type: 'node', parent: 'ena-group', label: 'Condensados', value: -0.36, icon: '💧', color: '#BDBDBD' },
                { id: 'ena-gas', type: 'node', parent: 'ena-group', label: 'Gas natural', value: -169.08, icon: '💨', color: '#03A9F4' },
                { id: 'ena-bagazo', type: 'node', parent: 'ena-group', label: 'Bagazo de caña', value: -0.98, icon: '🌿', color: '#8BC34A' },

                // Other nodes (not part of a group for now)
                { id: 'transformacion-total', type: 'node', label: 'Transformación Total', icon: '⚙️', color: '#f39c12', x: 550, y: 300 },
                { id: 'consumo-final-total', type: 'node', label: 'Consumo Final Total', icon: ' ', color: '#e74c3c', x: 950, y: 200 },
                { id: 'exportacion-total', type: 'node', label: 'Exportación Total', icon: '✈️', color: '#9b59b6', x: 950, y: 400 }
            ];

            const linksData = [
                // Links from Production to Transformation
                ...nodesData.filter(n => n.parent === 'prod-group' && n.value > 0).map(n => ({ source: n.id, target: 'transformacion-total', value: n.value })),
                // Links from Importation to Transformation
                ...nodesData.filter(n => n.parent === 'imp-group' && n.value > 0).map(n => ({ source: n.id, target: 'transformacion-total', value: n.value })),
                // Links from Variación Inventarios to Transformation (if positive)
                ...nodesData.filter(n => n.parent === 'varinv-group' && n.value > 0).map(n => ({ source: n.id, target: 'transformacion-total', value: n.value })),
                // Links from Transformation to Consumption and Exportation
                { source: 'transformacion-total', target: 'consumo-final-total', value: 7000 },
                { source: 'transformacion-total', target: 'exportacion-total', value: 2400 },
                // Links from Refinerías y Despuntadoras to Consumption
                ...nodesData.filter(n => n.parent === 'refdes-group' && n.value > 0).map(n => ({ source: n.id, target: 'consumo-final-total', value: n.value })),
                // Links from Plantas de Gas y Fraccionadoras to Consumption
                ...nodesData.filter(n => n.parent === 'pgfra-group' && n.value > 0).map(n => ({ source: n.id, target: 'consumo-final-total', value: n.value })),
                // Links from Centrales Eléctricas to Consumption
                ...nodesData.filter(n => n.parent === 'ce-group' && n.value > 0).map(n => ({ source: n.id, target: 'consumo-final-total', value: n.value })),
                // Links from Consumption to Exportation (example)
                ...nodesData.filter(n => n.parent === 'confin-group' && n.value > 0).map(n => ({ source: n.id, target: 'exportacion-total', value: n.value })),
                // Links from Energía No Aprovechada (example)
                ...nodesData.filter(n => n.parent === 'ena-group' && n.value < 0).map(n => ({ source: n.id, target: 'consumo-final-total', value: Math.abs(n.value) }))
            ];

            function findNodeById(id) {
                return nodesData.find(n => n.id === id);
            }

            function renderAll() {
                canvas.querySelectorAll('.sankey-node, .sankey-group-node, .sankey-grandparent-node').forEach(el => el.remove());
                
                nodesData.forEach(nodeInfo => {
                    if (nodeInfo.grandparent) return; // Only render top-level nodes (grandparents or standalone)
                    if (nodeInfo.parent) return; // Only render top-level nodes (grandparents or standalone)

                    let nodeElement;
                    if (nodeInfo.type === 'grandparent') {
                        nodeElement = createGrandparentElement(nodeInfo);
                        if (!nodeInfo.isCollapsed) {
                            const childrenGroups = nodesData.filter(n => n.grandparent === nodeInfo.id);
                            childrenGroups.forEach(groupInfo => {
                                const groupElement = createGroupElement(groupInfo);
                                nodeElement.appendChild(groupElement);
                                makeDraggable(groupElement); // Make groups draggable within grandparent
                                if (!groupInfo.isCollapsed) {
                                    const childrenNodes = nodesData.filter(n => n.parent === groupInfo.id && n.value !== 0); // Only render non-zero children
                                    childrenNodes.forEach(childInfo => {
                                        const childElement = createNodeElement(childInfo);
                                        groupElement.appendChild(childElement);
                                        makeDraggable(childElement); // Make child nodes draggable within group
                                    });
                                }
                            });
                        }
                    } else if (nodeInfo.type === 'group') { // Top-level groups (no grandparent)
                        nodeElement = createGroupElement(nodeInfo);
                        if (!nodeInfo.isCollapsed) {
                            const childrenNodes = nodesData.filter(n => n.parent === nodeInfo.id && n.value !== 0); // Only render non-zero children
                            childrenNodes.forEach(childInfo => {
                                const childElement = createNodeElement(childInfo);
                                nodeElement.appendChild(childElement);
                                makeDraggable(childElement);
                            });
                        }
                    } else { // Top-level standalone nodes
                        nodeElement = createNodeElement(nodeInfo);
                    }
                    canvas.appendChild(nodeElement);
                    makeDraggable(nodeElement); // Make top-level nodes draggable
                });

                setTimeout(redrawAllLinks, 0);
            }
            
            function createNodeElement(nodeInfo) {
                const nodeElement = document.createElement('div');
                nodeElement.id = nodeInfo.id;
                nodeElement.className = 'sankey-node';
                nodeElement.style.borderColor = nodeInfo.color;
                
                if(nodeInfo.parent){
                    const parentNode = findNodeById(nodeInfo.parent);
                    const childrenOfParent = nodesData.filter(n => n.parent === nodeInfo.parent && n.value !== 0);
                    const myIndex = childrenOfParent.findIndex(n => n.id === nodeInfo.id);
                    nodeElement.style.position = 'absolute';
                    // Position children within their parent group
                    nodeElement.style.left = `${20 + (myIndex % 2) * 40}px`; // Two columns
                    nodeElement.style.top = `${40 + Math.floor(myIndex / 2) * 40}px`; // Rows
                } else {
                    nodeElement.style.left = `${nodeInfo.x}px`;
                    nodeElement.style.top = `${nodeInfo.y}px`;
                }

                nodeElement.innerHTML = `
                    <div class="node-icon">${nodeInfo.icon}</div>
                    <div class="node-info">
                        <div class="node-label">${nodeInfo.label}</div>
                        <div class="node-value">${nodeInfo.value?.toFixed(2) || ''} PJ</div>
                    </div>
                    ${createMenuHtml(nodeInfo)}
                `;
                setupMenu(nodeElement, nodeInfo);
                return nodeElement;
            }

            function createGroupElement(nodeInfo) {
                const groupElement = document.createElement('div');
                groupElement.id = nodeInfo.id;
                const children = nodesData.filter(n => n.parent === nodeInfo.id && n.value !== 0); // Only count non-zero children
                const totalValue = children.reduce((sum, child) => sum + child.value, 0);

                if (nodeInfo.isCollapsed) {
                    groupElement.className = 'sankey-group-node collapsed-group'; // Collapsed group looks like a rectangulito
                    groupElement.style.width = '150px'; // Fixed width for collapsed rectangle
                    groupElement.style.height = '40px'; // Fixed height for collapsed rectangle
                    groupElement.innerHTML = `
                        <div class="node-icon">📦</div>
                        <div class="node-info">
                            <div class="node-label">${nodeInfo.label}</div>
                            <div class="node-value">${totalValue.toFixed(2)} PJ</div>
                        </div>
                        ${createMenuHtml(nodeInfo)}
                    `;
                } else {
                    groupElement.className = 'sankey-group-node';
                    const numChildren = children.length;
                    const rows = Math.ceil(numChildren / 2); // Two columns
                    const height = 45 + rows * 40 + 15; // Adjusted height based on children
                    const width = 120; // Adjusted width for two columns of circular nodes
                    groupElement.style.width = `${width}px`;
                    groupElement.style.height = `${height}px`;
                    groupElement.innerHTML = `
                        <div class="group-title">${nodeInfo.label}</div>
                        <div class="group-total-value">${totalValue.toFixed(2)} PJ</div>
                        ${createMenuHtml(nodeInfo)}
                    `;
                }
                
                if (nodeInfo.grandparent) {
                    const grandparent = findNodeById(nodeInfo.grandparent);
                    const siblingGroups = nodesData.filter(n => n.grandparent === nodeInfo.grandparent);
                    const myIndex = siblingGroups.findIndex(n => n.id === nodeInfo.id);
                    groupElement.style.position = 'absolute';
                    groupElement.style.left = `${20 + (myIndex % 2) * 150}px`; // Two columns of groups
                    groupElement.style.top = `${50 + Math.floor(myIndex / 2) * 200}px`; // Rows of groups
                } else {
                    groupElement.style.left = `${nodeInfo.x}px`;
                    groupElement.style.top = `${nodeInfo.y}px`;
                }
                groupElement.style.borderColor = nodeInfo.color;
                
                setupMenu(groupElement, nodeInfo);
                return groupElement;
            }

            function createGrandparentElement(nodeInfo) {
                const grandparentElement = document.createElement('div');
                grandparentElement.id = nodeInfo.id;
                grandparentElement.className = 'sankey-grandparent-node';
                
                const childrenGroups = nodesData.filter(n => n.grandparent === nodeInfo.id);
                const totalValue = childrenGroups.reduce((sum, group) => {
                    const groupChildren = nodesData.filter(n => n.parent === group.id && n.value !== 0);
                    return sum + groupChildren.reduce((childSum, child) => childSum + child.value, 0);
                }, 0);

                if (nodeInfo.isCollapsed) {
                    grandparentElement.className = 'sankey-node'; // Collapsed grandparent looks like a node
                    grandparentElement.style.width = '250px';
                    grandparentElement.style.height = 'auto';
                    grandparentElement.innerHTML = `
                        <div class="node-icon">🏛️</div>
                        <div class="node-info">
                            <div class="node-label">${nodeInfo.label}</div>
                            <div class="node-value">${totalValue.toFixed(2)} PJ</div>
                        </div>
                        ${createMenuHtml(nodeInfo)}
                    `;
                } else {
                    const numGroups = childrenGroups.length;
                    const rows = Math.ceil(numGroups / 2); // Two columns of groups
                    const height = 60 + rows * 200 + 20; // Adjusted height based on groups
                    const width = 350; // Adjusted width for two columns of groups
                    grandparentElement.style.width = `${width}px`;
                    grandparentElement.style.height = `${height}px`;
                    grandparentElement.innerHTML = `
                        <div class="grandparent-title">${nodeInfo.label}</div>
                        <div class="grandparent-total-value">${totalValue.toFixed(2)} PJ</div>
                        ${createMenuHtml(nodeInfo)}
                    `;
                }

                grandparentElement.style.left = `${nodeInfo.x}px`;
                grandparentElement.style.top = `${nodeInfo.y}px`;
                grandparentElement.style.borderColor = nodeInfo.color;

                setupMenu(grandparentElement, nodeInfo);
                return grandparentElement;
            }

            function createMenuHtml(nodeInfo) {
                let menuItems = `
                    <div class="popup-item" data-action="history">Ver histórico</div>
                    <div class="popup-item" data-action="charts">Ver gráficos</div>
                `;
                if (nodeInfo.type === 'group' || nodeInfo.type === 'grandparent') {
                    const actionText = nodeInfo.isCollapsed ? 'Expandir' : 'Contraer';
                    menuItems += `<div class="popup-item" data-action="toggle-collapse">${actionText}</div>`;
                }
                 return `
                    <div class="node-add-button" style="background-color: ${nodeInfo.color};">+</div>
                    <div class="node-popup-menu">${menuItems}</div>
                `;
            }
            
            function setupMenu(nodeElement, nodeInfo) {
                const button = nodeElement.querySelector('.node-add-button');
                if(!button) return;

                button.addEventListener('click', e => {
                    e.stopPropagation();
                    const menu = nodeElement.querySelector('.node-popup-menu');
                    const isVisible = menu.classList.contains('visible');
                    closeAllPopups();
                    if (!isVisible) menu.classList.add('visible');
                });
                
                nodeElement.querySelectorAll('.popup-item').forEach(item => {
                    item.addEventListener('click', e => {
                        e.stopPropagation();
                        const action = e.currentTarget.dataset.action;
                        if (action === 'toggle-collapse') {
                            nodeInfo.isCollapsed = !nodeInfo.isCollapsed;
                            renderAll();
                        } else {
                            console.log(`Acción '${action}' en el nodo '${nodeInfo.id}'`);
                        }
                        closeAllPopups();
                    });
                });
            }

            function closeAllPopups() {
                document.querySelectorAll('.node-popup-menu.visible').forEach(menu => menu.classList.remove('visible'));
            }

            function makeDraggable(element) {
                element.addEventListener('mousedown', onMouseDown);
                function onMouseDown(e) {
                    e.stopPropagation(); // FIX: Previene que el evento se propague al padre
                    if (e.button !== 0 || e.target.closest('.node-add-button')) return;
                    let wasDragged = false;
                    element.classList.add('dragging');
                    const nodeData = findNodeById(element.id);
                    const rect = element.getBoundingClientRect(), canvasRect = canvas.getBoundingClientRect();
                    const offsetX = e.clientX - rect.left, offsetY = e.clientY - rect.top;

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);

                    function onMouseMove(e) {
                        wasDragged = true; e.preventDefault(); closeAllPopups();
                        let x = e.clientX - canvasRect.left - offsetX;
                        let y = e.clientY - canvasRect.top - offsetY;
                        element.style.left = `${x}px`; element.style.top = `${y}px`;
                        nodeData.x = x; nodeData.y = y;
                        redrawAllLinks();
                    }
                    function onMouseUp(e) {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                        element.classList.remove('dragging');
                        if (!wasDragged) {
                            focusedNodeId = element.id;
                            updateFocus();
                        }
                    }
                }
            }
            
            function getDownstreamFlow(startNodeId) {
                const nodesToVisit = [startNodeId];
                const highlightedNodes = new Set([startNodeId]);
                const highlightedLinks = new Set();
                const startNode = findNodeById(startNodeId);

                // Helper to add nodes and their direct children/groups to the highlight set
                const addNodeAndChildrenToHighlight = (nodeId) => {
                    const node = findNodeById(nodeId);
                    if (!node) return;

                    highlightedNodes.add(nodeId);

                    if (node.type === 'grandparent' && !node.isCollapsed) {
                        nodesData.filter(n => n.grandparent === nodeId).forEach(group => {
                            addNodeAndChildrenToHighlight(group.id);
                        });
                    } else if (node.type === 'group' && !node.isCollapsed) {
                        nodesData.filter(n => n.parent === nodeId).forEach(child => {
                            highlightedNodes.add(child.id);
                        });
                    }
                };

                addNodeAndChildrenToHighlight(startNodeId);

                while (nodesToVisit.length > 0) {
                    const currentNodeId = nodesToVisit.shift();
                    const currentNode = findNodeById(currentNodeId);

                    if (!currentNode) continue;

                    let sourcesForLinks = [];

                    if (currentNode.type === 'node') {
                        sourcesForLinks.push(currentNodeId);
                    } else if (currentNode.type === 'group' && currentNode.isCollapsed) {
                        // If a collapsed group is focused, its outgoing links are from the group itself
                        sourcesForLinks.push(currentNodeId);
                    } else if (currentNode.type === 'group' && !currentNode.isCollapsed) {
                        // If an expanded group is focused, its outgoing links are from its children
                        nodesData.filter(n => n.parent === currentNodeId).forEach(child => {
                            sourcesForLinks.push(child.id);
                        });
                    } else if (currentNode.type === 'grandparent' && currentNode.isCollapsed) {
                        // If a collapsed grandparent is focused, its outgoing links are from the grandparent itself
                        sourcesForLinks.push(currentNodeId);
                    } else if (currentNode.type === 'grandparent' && !currentNode.isCollapsed) {
                        // If an expanded grandparent is focused, its outgoing links are from its direct children groups
                        nodesData.filter(n => n.grandparent === currentNodeId).forEach(group => {
                            nodesData.filter(n => n.parent === group.id).forEach(child => {
                                sourcesForLinks.push(child.id);
                            });
                        });
                    }

                    sourcesForLinks.forEach(sourceId => {
                        linksData
                            .filter(link => link.source === sourceId)
                            .forEach(link => {
                                const linkId = `path-${link.source}-to-${link.target}`;
                                if (!highlightedLinks.has(linkId)) {
                                    highlightedLinks.add(linkId);
                                    addNodeAndChildrenToHighlight(link.target); // Highlight target and its children/groups
                                    nodesToVisit.push(link.target);
                                }
                            });
                    });
                }
                return { nodes: highlightedNodes, links: highlightedLinks };
            }

            function updateFocus() {
                const flow = focusedNodeId ? getDownstreamFlow(focusedNodeId) : null;
                const startNode = focusedNodeId ? findNodeById(focusedNodeId) : null;

                document.querySelectorAll('.sankey-node, .sankey-group-node, .sankey-grandparent-node').forEach(el => {
                    el.classList.remove('focused', 'faded');
                    if (flow) {
                        if (flow.nodes.has(el.id)) {
                            el.classList.add('focused');
                        } else {
                            let isRelated = false;
                            if (startNode) {
                                if (startNode.parent === el.id || startNode.grandparent === el.id) {
                                    isRelated = true;
                                }
                                // Check if the element is a parent of the focused node's parent
                                const focusedParent = startNode.parent ? findNodeById(startNode.parent) : null;
                                if (focusedParent && focusedParent.id === el.id) {
                                    isRelated = true;
                                }
                                // Check if the element is a grandparent of the focused node's grandparent
                                const focusedGrandparent = startNode.grandparent ? findNodeById(startNode.grandparent) : null;
                                if (focusedGrandparent && focusedGrandparent.id === el.id) {
                                    isRelated = true;
                                }
                            }
                            if (!isRelated) {
                                el.classList.add('faded');
                            }
                        }
                    }
                });

                svgLinks.querySelectorAll('.sankey-link, .particle').forEach(el => {
                    el.classList.remove('faded');
                    if (flow && !flow.links.has(el.id)) {
                        el.classList.add('faded');
                    }
                });
            }

            function redrawAllLinks() {
                svgLinks.innerHTML = '';
                const virtualLinks = [];
                const groupLinks = {};
                const grandparentLinks = {};

                linksData.forEach(link => {
                    const sourceNode = findNodeById(link.source);
                    const targetNode = findNodeById(link.target);

                    let effectiveSourceId = link.source;
                    let effectiveTargetId = link.target;
                    let effectiveValue = link.value;

                    // Handle collapsed children within a group
                    const sourceParentGroup = sourceNode.parent ? findNodeById(sourceNode.parent) : null;
                    if (sourceParentGroup && sourceParentGroup.isCollapsed) {
                        effectiveSourceId = sourceParentGroup.id;
                    }

                    const targetParentGroup = targetNode.parent ? findNodeById(targetNode.parent) : null;
                    if (targetParentGroup && targetParentGroup.isCollapsed) {
                        effectiveTargetId = targetParentGroup.id;
                    }

                    // Handle collapsed groups within a grandparent
                    const sourceGrandparent = sourceParentGroup && sourceParentGroup.grandparent ? findNodeById(sourceParentGroup.grandparent) : null;
                    if (sourceGrandparent && sourceGrandparent.isCollapsed) {
                        effectiveSourceId = sourceGrandparent.id;
                    }

                    const targetGrandparent = targetParentGroup && targetParentGroup.grandparent ? findNodeById(targetParentGroup.grandparent) : null;
                    if (targetGrandparent && targetGrandparent.isCollapsed) {
                        effectiveTargetId = targetGrandparent.id;
                    }

                    const key = `${effectiveSourceId}->${effectiveTargetId}`;
                    if (effectiveSourceId !== effectiveTargetId) { // Avoid self-loops
                        if (!virtualLinks.some(vl => vl.source === effectiveSourceId && vl.target === effectiveTargetId)) {
                            virtualLinks.push({
                                source: effectiveSourceId,
                                target: effectiveTargetId,
                                value: effectiveValue,
                                originalLinks: [link]
                            });
                        } else {
                            virtualLinks.find(vl => vl.source === effectiveSourceId && vl.target === effectiveTargetId).value += effectiveValue;
                            virtualLinks.find(vl => vl.source === effectiveSourceId && vl.target === effectiveTargetId).originalLinks.push(link);
                        }
                    }
                });
                
                const maxValue = Math.max(...virtualLinks.map(l => l.value), 1);
                
                virtualLinks.forEach(linkInfo => {
                    const sourceNodeEl = document.getElementById(linkInfo.source);
                    const targetNodeEl = document.getElementById(linkInfo.target);

                    if (sourceNodeEl && targetNodeEl) {
                        const path = document.createElementNS(SVG_NS, 'path');
                        const pathId = `path-${linkInfo.source}-to-${linkInfo.target}`;
                        
                        path.setAttribute('id', pathId);
                        path.setAttribute('class', 'sankey-link');
                        
                        const maxAllowedWidth = Math.min(sourceNodeEl.offsetHeight, targetNodeEl.offsetHeight) * 0.9;
                        const calculatedWidth = (linkInfo.value / maxValue) * 50;
                        const strokeWidth = Math.min(Math.max(2, calculatedWidth), maxAllowedWidth);

                        path.setAttribute('stroke-width', strokeWidth);
                        path.setAttribute('d', getLinkPath(sourceNodeEl, targetNodeEl));
                        svgLinks.appendChild(path);

                        createParticlesForLink(pathId, linkInfo);
                    }
                });
                updateFocus();
            }

            function getLinkPath(source, target) {
                const canvasRect = canvas.getBoundingClientRect();
                const sourceRect = source.getBoundingClientRect();
                const targetRect = target.getBoundingClientRect();
                
                let x1, y1, x2, y2;

                // Calculate source coordinates
                if (source.classList.contains('sankey-node')) { // Child node
                    x1 = (sourceRect.right - canvasRect.left);
                    y1 = (sourceRect.top - canvasRect.top) + sourceRect.height / 2;
                } else if (source.classList.contains('sankey-group-node')) { // Parent node (group)
                    x1 = (sourceRect.right - canvasRect.left);
                    y1 = (sourceRect.top - canvasRect.top) + sourceRect.height / 2;
                } else if (source.classList.contains('sankey-grandparent-node')) { // Grandparent node
                    x1 = (sourceRect.right - canvasRect.left);
                    y1 = (sourceRect.top - canvasRect.top) + sourceRect.height / 2;
                } else { // Fallback for other top-level nodes
                    x1 = (sourceRect.right - canvasRect.left);
                    y1 = (sourceRect.top - canvasRect.top) + sourceRect.height / 2;
                }

                // Calculate target coordinates
                if (target.classList.contains('sankey-node')) { // Child node
                    x2 = (targetRect.left - canvasRect.left);
                    y2 = (targetRect.top - canvasRect.top) + targetRect.height / 2;
                } else if (target.classList.contains('sankey-group-node')) { // Parent node (group)
                    x2 = (targetRect.left - canvasRect.left);
                    y2 = (targetRect.top - canvasRect.top) + targetRect.height / 2;
                } else if (target.classList.contains('sankey-grandparent-node')) { // Grandparent node
                    x2 = (targetRect.left - canvasRect.left);
                    y2 = (targetRect.top - canvasRect.top) + targetRect.height / 2;
                } else { // Fallback for other top-level nodes
                    x2 = (targetRect.left - canvasRect.left);
                    y2 = (targetRect.top - canvasRect.top) + targetRect.height / 2;
                }

                const controlX1 = x1 + (x2 - x1) / 2;
                return `M ${x1} ${y1} C ${controlX1} ${y1}, ${controlX1} ${y2}, ${x2} ${y2}`;
            }

            function createParticlesForLink(pathId, currentLink) {
                let colorMix = [];
                // If the link represents aggregated flow from multiple original links
                if (currentLink.originalLinks && currentLink.originalLinks.length > 0) {
                    currentLink.originalLinks.forEach(originalLink => {
                        const sourceNode = findNodeById(originalLink.source);
                        if (sourceNode) {
                            colorMix.push({ color: sourceNode.color, value: originalLink.value });
                        }
                    });
                } else {
                    // For direct links, use the source node's color
                    const sourceNode = findNodeById(currentLink.source);
                    if (sourceNode) {
                        colorMix.push({ color: sourceNode.color, value: currentLink.value });
                    }
                }
                
                const totalMixValue = colorMix.reduce((sum, mix) => sum + mix.value, 0);
                const particleCount = Math.ceil(Math.log(currentLink.value + 1) * 4);
                const duration = 6 - Math.log10(currentLink.value + 1);

                for (let i = 0; i < particleCount; i++) {
                    let selectedColor = colorMix.length > 0 ? colorMix[0].color : '#e0e0e0'; // Default color if no mix
                    if (totalMixValue > 0) {
                        const randomVal = Math.random() * totalMixValue;
                        let cumulativeValue = 0;
                        for (const mix of colorMix) {
                            cumulativeValue += mix.value;
                            if (randomVal <= cumulativeValue) {
                                selectedColor = mix.color;
                                break;
                            }
                        }
                    }

                    const particle = document.createElementNS(SVG_NS, 'circle');
                    particle.id = pathId;
                    particle.setAttribute('class', 'particle');
                    particle.setAttribute('r', '3.5');
                    particle.setAttribute('fill', selectedColor);
                    
                    const animateMotion = document.createElementNS(SVG_NS, 'animateMotion');
                    animateMotion.setAttribute('dur', `${Math.max(2, duration)}s`);
                    animateMotion.setAttribute('repeatCount', 'indefinite');
                    animateMotion.setAttribute('begin', `${Math.random() * duration}s`);
                    
                    const mpath = document.createElementNS(SVG_NS, 'mpath');
                    mpath.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#${pathId}`);
                    
                    animateMotion.appendChild(mpath);
                    particle.appendChild(animateMotion);
                    svgLinks.appendChild(particle);
                }
            }
            
            canvas.addEventListener('click', (e) => {
                if(e.target === canvas) {
                    focusedNodeId = null;
                    updateFocus();
                    closeAllPopups();
                }
            });

            renderAll();
        });
    </script>
</body>
</html>
